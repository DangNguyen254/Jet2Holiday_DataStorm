<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quản lý Cảnh báo tồn kho</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="../assets/css/styles.css" rel="stylesheet" />

  
</head>
<body>
  <nav class="navbar app-nav sticky-top">
    <div class="container-fluid px-3 px-md-4">
      <div class="d-flex align-items-center gap-2">
        <span class="bg-primary-subtle text-primary p-2 rounded-3"><i class="fa-solid fa-bell"></i></span>
        <span class="fw-semibold">Cảnh báo tồn kho</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a href="dashboard.html" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
        <a href="forecast.html" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-magnifying-glass-chart"></i> Forecast</a>
        <a href="inventory.html" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-box"></i> Tồn kho</a>
        <a href="report.html" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-chart-pie"></i> Báo cáo</a>
        <a href="upload.html" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-cloud-arrow-up"></i> Tải dữ liệu</a>
        <button id="btnDark" class="btn btn-sm btn-outline-secondary" aria-label="Đổi giao diện sáng/tối"><i class="fa-solid fa-moon"></i></button>
      </div>
    </div>
  </nav>

  <main class="container-fluid px-3 px-md-4 py-4">
    <!-- Bộ lọc -->
    <section class="card card-soft p-3 p-md-4 mb-4" aria-label="Bộ lọc">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-2">
          <label class="form-label">Khu vực</label>
          <select id="fRegion" class="form-select">
            <option value="all" selected>Tất cả</option>
            <option>Hà Nội</option>
            <option>Đà Nẵng</option>
            <option>Hồ Chí Minh</option>
          </select>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Cửa hàng</label>
          <select id="fStore" class="form-select">
            <option value="all" selected>Tất cả</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Loại cảnh báo</label>
          <select id="fType" class="form-select">
            <option value="all" selected>Tất cả</option>
            <option value="stockout">Stock-out sắp xảy ra</option>
            <option value="spike">Nhu cầu tăng đột biến</option>
            <option value="late">Giao hàng trễ</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Mức độ</label>
          <select id="fSev" class="form-select">
            <option value="all" selected>Tất cả</option>
            <option value="Cao">Cao</option>
            <option value="Trung bình">Trung bình</option>
            <option value="Thấp">Thấp</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Trạng thái</label>
          <select id="fStatus" class="form-select">
            <option value="all" selected>Tất cả</option>
            <option value="Mới">Mới</option>
            <option value="Đang xử lý">Đang xử lý</option>
            <option value="Đã giải quyết">Đã giải quyết</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Từ ngày</label>
          <input id="fFrom" type="date" class="form-control" />
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Đến ngày</label>
          <input id="fTo" type="date" class="form-control" />
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Tìm kiếm</label>
          <input id="fSearch" type="text" class="form-control" placeholder="SKU/Sản phẩm/Cửa hàng..." />
        </div>
        <div class="col-12 col-md-3 ms-auto d-flex gap-2 justify-content-end">
          <button id="btnReset" class="btn btn-outline-secondary"><i class="fa-solid fa-rotate"></i> Đặt lại</button>
          <button id="btnExport" class="btn btn-primary"><i class="fa-solid fa-file-arrow-down"></i> Xuất CSV</button>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="row g-3 mb-4">
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card card-soft p-3 h-100">
          <div class="d-flex align-items-center gap-3">
            <span class="kpi-icon bg-primary-subtle text-primary"><i class="fa-solid fa-bell"></i></span>
            <div>
              <div class="kpi-title">Tổng cảnh báo</div>
              <div class="kpi-value" id="kpiTotal">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card card-soft p-3 h-100">
          <div class="d-flex align-items-center gap-3">
            <span class="kpi-icon bg-warning-subtle text-warning"><i class="fa-solid fa-signal"></i></span>
            <div>
              <div class="kpi-title">Mức độ Cao</div>
              <div class="kpi-value" id="kpiHigh">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card card-soft p-3 h-100">
          <div class="d-flex align-items-center gap-3">
            <span class="kpi-icon bg-info-subtle text-info"><i class="fa-solid fa-hourglass-half"></i></span>
            <div>
              <div class="kpi-title">Đang xử lý</div>
              <div class="kpi-value" id="kpiProc">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card card-soft p-3 h-100">
          <div class="d-flex align-items-center gap-3">
            <span class="kpi-icon bg-success-subtle text-success"><i class="fa-solid fa-circle-check"></i></span>
            <div>
              <div class="kpi-title">Đã giải quyết</div>
              <div class="kpi-value" id="kpiDone">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Danh sách cảnh báo -->
    <section class="card card-soft p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="m-0">Danh sách cảnh báo</h6>
        <div class="d-flex align-items-center gap-2">
          <small id="pageInfo" class="text-muted"></small>
          <div class="btn-group btn-group-sm" role="group" aria-label="Phân trang">
            <button id="btnPrev" class="btn btn-outline-secondary" aria-label="Trang trước">‹</button>
            <button id="btnNext" class="btn btn-outline-secondary" aria-label="Trang sau">›</button>
          </div>
        </div>
      </div>
      <div class="table-responsive">
  <table class="table align-middle sortable">
          <thead>
            <tr>
              <th>Loại</th>
              <th>Mức độ</th>
              <th>Cửa hàng</th>
              <th>Thời gian</th>
              <th>Trạng thái</th>
              <th class="text-end">Hành động</th>
            </tr>
          </thead>
          <tbody id="tblAlerts"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../vendor/mock-data.js"></script>
  <script src="../vendor/table-sort.js"></script>
  <script>
    // -----------------------
    // Mock data
    // -----------------------
    // Derive product meta from shared dataset for alignment
    const DATASET = MockData.getDataset();
    const _prodMap = {};
    for (const r of DATASET){ if (!_prodMap[r.sku]) _prodMap[r.sku] = { sku: r.sku, name: r.product, category: r.category, region: r.region, store: r.store }; }
    const products = Object.values(_prodMap);
    const regionMap = { 'Hà Nội':'North', 'Đà Nẵng':'Central', 'Hồ Chí Minh':'South' };
    const typeMap = {
      stockout: 'Stock-out sắp xảy ra',
      spike: 'Nhu cầu tăng đột biến (khuyến mãi/thời tiết)',
      late: 'Giao hàng trễ (ETA > ngưỡng)'
    };

    function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); return d; }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtDateTime(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

    // Generate mock alerts
    let alerts = [];
    (function genMock(){
      const severities = ['Cao','Trung bình','Thấp'];
      const statuses = ['Mới','Đang xử lý','Đã giải quyết'];
      const types = ['stockout','spike','late'];
      let id = 1;
      for (let i=0;i<60;i++){
        const p = randPick(products);
        const t = randPick(types);
        const sev = randPick(severities);
        const stt = randPick(statuses);
        const dayBack = Math.floor(Math.random()*14); // within 14 days
        const when = daysAgo(dayBack);
        when.setHours(Math.floor(Math.random()*24), Math.floor(Math.random()*60), 0, 0);
        const desc =
          t==='stockout' ? `SKU ${p.sku} (${p.name}) tồn kho thấp, dự kiến hết trong ${2+Math.floor(Math.random()*6)} giờ.` :
          t==='spike'    ? `Nhu cầu ${p.name} tăng mạnh do ${Math.random()<.5?'khuyến mãi':'thời tiết'}.` :
                           `Đơn giao ${p.sku} đến ${p.store} trễ ${30+Math.floor(Math.random()*120)} phút.`;
        alerts.push({
          id: id++,
          type: t,
          severity: sev,
          region: p.region,
          store: p.store,
          time: when,
          status: stt,
          sku: p.sku,
          product: p.name,
          description: desc
        });
      }
      // Stable newest-first by time
      alerts.sort((a,b)=> b.time - a.time);
    })();

    // -----------------------
    // Elements and state
    // -----------------------
    const elRegion = document.getElementById('fRegion');
    const elStore  = document.getElementById('fStore');
    const elType   = document.getElementById('fType');
    const elSev    = document.getElementById('fSev');
    const elStatus = document.getElementById('fStatus');
    const elFrom   = document.getElementById('fFrom');
    const elTo     = document.getElementById('fTo');
    const elSearch = document.getElementById('fSearch');
    const elTbl    = document.getElementById('tblAlerts');
    const elPageInfo = document.getElementById('pageInfo');
    const btnPrev  = document.getElementById('btnPrev');
    const btnNext  = document.getElementById('btnNext');
    const btnReset = document.getElementById('btnReset');
    const btnExport= document.getElementById('btnExport');

    const elTotal = document.getElementById('kpiTotal');
    const elHigh  = document.getElementById('kpiHigh');
    const elProc  = document.getElementById('kpiProc');
    const elDone  = document.getElementById('kpiDone');

    let page = 1;
    const PAGE_SIZE = 10;

    // -----------------------
    // Helpers
    // -----------------------
    function unique(arr){ return [...new Set(arr)]; }
    function populateStores(){
      const ui = elRegion.value;
      const code = regionMap[ui] || ui;
      const stores = unique(products.filter(p => ui==='all' ? true : p.region===code).map(p=>p.store)).sort();
      elStore.innerHTML = '<option value="all" selected>Tất cả</option>' + stores.map(s => `<option>${s}</option>`).join('');
    }
    function dateOnly(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function inRange(d, fromIso, toIso){
      const D = dateOnly(d);
      const okFrom = fromIso ? D >= new Date(fromIso + 'T00:00:00') : true;
      const okTo   = toIso   ? D <= new Date(toIso + 'T00:00:00')   : true;
      return okFrom && okTo;
    }
    function sevBadge(sev){
      if (sev==='Cao') return 'badge-sev-high';
      if (sev==='Trung bình') return 'badge-sev-med';
      return 'badge-sev-low';
    }
    function statusBadge(st){
      if (st==='Mới') return 'badge-st-new';
      if (st==='Đang xử lý') return 'badge-st-proc';
      return 'badge-st-done';
    }

    // -----------------------
    // Filtering + rendering
    // -----------------------
    function applyFilters(){
      const uiRegion = elRegion.value;
      const regionCode = regionMap[uiRegion] || uiRegion;
      const q = elSearch.value.trim().toLowerCase();
      const filtered = alerts.filter(a =>
        (uiRegion==='all' || a.region===regionCode) &&
        (elStore.value==='all' || a.store===elStore.value) &&
        (elType.value==='all' || a.type===elType.value) &&
        (elSev.value==='all' || a.severity===elSev.value) &&
        (elStatus.value==='all' || a.status===elStatus.value) &&
        inRange(a.time, elFrom.value, elTo.value) &&
        (q==='' || [a.sku, a.product, a.store, typeMap[a.type]].some(x => String(x).toLowerCase().includes(q)))
      );
      return filtered;
    }

    function renderKPIs(list){
      elTotal.textContent = list.length;
      elHigh.textContent  = list.filter(a=>a.severity==='Cao').length;
      elProc.textContent  = list.filter(a=>a.status==='Đang xử lý').length;
      elDone.textContent  = list.filter(a=>a.status==='Đã giải quyết').length;
    }

    function renderTable(list){
      const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
      if (page > totalPages) page = totalPages;
      const start = (page - 1) * PAGE_SIZE;
      const slice = list.slice(start, start + PAGE_SIZE);

      elTbl.innerHTML = '';
      slice.forEach(a => {
        const typeLabel = typeMap[a.type] || a.type;
        elTbl.insertAdjacentHTML('beforeend', `
          <tr>
            <td>
              <div class="fw-semibold"><i class="fa-solid ${a.type==='stockout'?'fa-triangle-exclamation text-warning':(a.type==='spike'?'fa-bolt text-info':'fa-truck text-secondary')} me-2"></i>${typeLabel}</div>
              <div class="small text-muted">${a.description}</div>
            </td>
            <td><span class="badge ${sevBadge(a.severity)}">${a.severity}</span></td>
            <td><div class="fw-semibold">${a.store}</div><div class="small text-muted">${a.region}</div></td>
            <td>${fmtDateTime(a.time)}</td>
            <td><span class="badge ${statusBadge(a.status)}">${a.status}</span></td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" title="Đánh dấu đang xử lý" onclick="setStatus(${a.id}, 'Đang xử lý')"><i class="fa-solid fa-hourglass-half"></i></button>
                <button class="btn btn-outline-success" title="Đánh dấu đã giải quyết" onclick="setStatus(${a.id}, 'Đã giải quyết')"><i class="fa-solid fa-check"></i></button>
              </div>
            </td>
          </tr>
        `);
      });

      elPageInfo.textContent = `Trang ${page}/${totalPages} • ${list.length} mục`;
      btnPrev.disabled = page <= 1;
      btnNext.disabled = page >= totalPages;
      if (window.TableSortEnhance) TableSortEnhance();
    }

    function refresh(){
      const list = applyFilters();
      renderKPIs(list);
      renderTable(list);
    }

    // -----------------------
    // Actions
    // -----------------------
    function setStatus(id, st){
      const idx = alerts.findIndex(a=>a.id===id);
      if (idx>=0){ alerts[idx].status = st; refresh(); }
    }
    window.setStatus = setStatus;

    function exportCSV(){
      const rows = applyFilters().map(a => ({
        ID: a.id,
        Loai: typeMap[a.type],
        MucDo: a.severity,
        KhuVuc: a.region,
        CuaHang: a.store,
        ThoiGian: fmtDateTime(a.time),
        TrangThai: a.status,
        SKU: a.sku,
        SanPham: a.product,
        MoTa: a.description
      }));
      const header = Object.keys(rows[0] || {ID:'',Loai:'',MucDo:'',KhuVuc:'',CuaHang:'',ThoiGian:'',TrangThai:'',SKU:'',SanPham:'',MoTa:''});
      const csv = [
        header.join(','),
        ...rows.map(r => header.map(h => `"${String(r[h]).replace(/"/g,'""')}"`).join(','))
      ].join('\r\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `alerts_export_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // -----------------------
    // Init
    // -----------------------
    function initDates(){
      const today = new Date();
      const from = new Date(today); from.setDate(from.getDate()-6);
      elFrom.value = from.toISOString().slice(0,10);
      elTo.value   = today.toISOString().slice(0,10);
    }

    elRegion.addEventListener('change', ()=>{ populateStores(); elStore.value='all'; page=1; refresh(); });
    elStore.addEventListener('change', ()=>{ page=1; refresh(); });
    [elType, elSev, elStatus, elFrom, elTo].forEach(el => el.addEventListener('change', ()=>{ page=1; refresh(); }));
    elSearch.addEventListener('input', ()=>{ page=1; refresh(); });
    btnPrev.addEventListener('click', ()=>{ if (page>1){ page--; refresh(); }});
    btnNext.addEventListener('click', ()=>{ page++; refresh(); });
    btnReset.addEventListener('click', ()=>{
      elRegion.value='all'; populateStores(); elStore.value='all';
      elType.value='all'; elSev.value='all'; elStatus.value='all';
      elSearch.value=''; initDates(); page=1; refresh();
    });
    btnExport.addEventListener('click', exportCSV);

    const btnDark = document.getElementById('btnDark');
    btnDark.addEventListener('click', ()=>{ document.body.classList.toggle('dark'); });

    populateStores();
    initDates();
    refresh();
  </script>
</body>
</html>
